<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT System - Ultra Sync & Export</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --blue: #58a6ff; --green: #3fb950; --red: #f85149; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        /* Header & Navigation */
        .header { text-align: center; margin-bottom: 15px; }
        .btn-group { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn { background: var(--card); color: #8b949e; border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-node.active { border-color: var(--blue); color: var(--blue); background: rgba(88, 166, 255, 0.1); }
        .btn-page.active { background: var(--red); color: white; border-color: var(--red); }

        /* Pages */
        .page { display: none; } .page.active { display: block; }

        /* Dashboard Layout */
        .main-layout { display: flex; gap: 15px; max-width: 1600px; margin: auto; }
        .left-charts { flex: 3; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .right-data { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        .stat-val { font-size: 34px; font-weight: 800; color: var(--blue); text-align: center; margin: 5px 0; }
        
        /* History Page Controls */
        .history-controls { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #21262d; padding: 15px; border-radius: 12px; border: 1px solid var(--green);
            margin-bottom: 15px; max-width: 1200px; margin: auto; flex-wrap: wrap; gap: 15px;
        }
        input[type="date"] { background: #0d1117; color: white; border: 1px solid var(--blue); padding: 8px; border-radius: 6px; color-scheme: dark; }

        /* Table Style */
        .table-wrap { max-width: 1200px; margin: auto; background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
        th { background: #1f242c; color: var(--blue); padding: 12px; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: var(--green); font-size: 11px; text-align: center; padding: 4px; z-index: 999; }

        @media (max-width: 1000px) { .main-layout { flex-direction: column; } .left-charts { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <h1>IOT MULTI-NODE MONITOR</h1>
    <div class="btn-group">
        <button class="btn btn-node active" onclick="selectNode(0, this)">NODE 1</button>
        <button class="btn btn-node" onclick="selectNode(1, this)">NODE 2</button>
        <button class="btn btn-node" onclick="selectNode(2, this)">NODE 3</button>
        <button class="btn btn-node" onclick="selectNode(3, this)">NODE 4</button>
    </div>
    <div class="btn-group">
        <button class="btn btn-page active" onclick="switchPage('dash', this)">DASHBOARD</button>
        <button class="btn btn-page" onclick="switchPage('table', this)">LỊCH SỬ</button>
    </div>
</div>

<div id="dash" class="page active">
    <div class="main-layout">
        <div class="left-charts">
            <div class="card" style="height:270px"><canvas id="cT"></canvas></div>
            <div class="card" style="height:270px"><canvas id="cH"></canvas></div>
            <div class="card" style="height:270px"><canvas id="cL"></canvas></div>
            <div class="card" style="height:270px"><canvas id="cG"></canvas></div>
        </div>
        <div class="right-data">
            <div class="card"><div>Nhiệt độ (°C)</div><div id="vT" class="stat-val">--</div></div>
            <div class="card"><div>Độ ẩm (%)</div><div id="vH" class="stat-val">--</div></div>
            <div class="card"><div>Ánh sáng (Lux)</div><div id="vL" class="stat-val">--</div></div>
            <div class="card"><div>Khí CO2 (ppm)</div><div id="vG" class="stat-val">--</div></div>
        </div>
    </div>
</div>

<div id="table" class="page">
    <div class="history-controls">
        <div><strong>ĐỐI TƯỢNG:</strong> <span id="nodeLabel" style="color:var(--blue)">NODE 1</span></div>
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <span>Ngày cần xuất file:</span>
            <input type="date" id="exportDate">
            <button class="btn" style="border-color:var(--green); color:var(--green);" onclick="exportDailyCSV()">XUẤT CSV CẢ NGÀY</button>
        </div>
    </div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>Thời gian</th><th>Nhiệt độ</th><th>Độ ẩm</th><th>Ánh sáng</th><th>Khí CO2</th></tr></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<div id="status-bar">Đang khởi tạo kết nối...</div>

<script>
    const nodes = [
        { id: "3206839", key: "YOVTV2A6N3NADZFU", name: "NODE 1" },
        { id: "3206869", key: "JBNAL9NDRB90ESWX", name: "NODE 2" },
        { id: "3206872", key: "JVSQYZ2HNBACNOWE", name: "NODE 3" },
        { id: "3206874", key: "YDKVK372O04PHALZ", name: "NODE 4" }
    ];

    let activeIdx = 0, charts = {}, mainSyncTimer = null;
    document.getElementById('exportDate').valueAsDate = new Date();

    function initCharts() {
        const create = (id, label, color) => new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color+'10', fill: true, tension: 0.3, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: false }, y: { grid: { color: '#30363d' } } } }
        });
        charts.t = create('cT', 'Nhiệt độ', '#ff7b72'); charts.h = create('cH', 'Độ ẩm', '#79c0ff');
        charts.l = create('cL', 'Ánh sáng', '#d29922'); charts.g = create('cG', 'Khí CO2', '#7ee787');
    }

    // --- HÀM ĐỒNG BỘ DỮ LIỆU TỔNG THỂ ---
    function syncAll() {
        const node = nodes[activeIdx];
        const api = `https://api.thingspeak.com/channels/${node.id}/feeds.json?api_key=${node.key}&results=20`;

        $.getJSON(api, function(res) {
            const feeds = res.feeds;
            if (feeds && feeds.length > 0) {
                const last = feeds[feeds.length - 1];
                const labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}));
                
                // 1. Dashboard
                $("#vT").text(parseFloat(last.field1 || 0).toFixed(1));
                $("#vH").text(parseFloat(last.field2 || 0).toFixed(1));
                $("#vL").text(parseFloat(last.field3 || 0).toFixed(0));
                $("#vG").text(last.field4 || "0");

                // 2. Biểu đồ (Cập nhật 20 điểm dữ liệu mới)
                const updateChart = (c, fld) => { 
                    c.data.labels = labels; 
                    c.data.datasets[0].data = feeds.map(f => f[fld]); 
                    c.update('none'); 
                };
                updateChart(charts.t, 'field1'); updateChart(charts.h, 'field2'); 
                updateChart(charts.l, 'field3'); updateChart(charts.g, 'field4');

                // 3. Bảng Lịch sử (Chỉ hiển thị 20 dòng gần nhất)
                let tableHtml = ""; 
                [...feeds].reverse().forEach(f => {
                    tableHtml += `<tr><td>${new Date(f.created_at).toLocaleString('vi-VN')}</td><td>${f.field1 || '--'}</td><td>${f.field2 || '--'}</td><td>${f.field3 || '--'}</td><td>${f.field4 || '--'}</td></tr>`;
                });
                $("#tBody").html(tableHtml);

                $("#status-bar").text(`CẬP NHẬT THÀNH CÔNG ${node.name}: ` + new Date().toLocaleTimeString());
            }
        }).fail(() => $("#status-bar").text("LỖI KẾT NỐI API THINGSPEAK!"));
    }

    // --- XUẤT FILE THEO NGÀY LỰA CHỌN ---
    function exportDailyCSV() {
        const node = nodes[activeIdx];
        const pickedDate = document.getElementById('exportDate').value;
        if(!pickedDate) return alert("Hãy chọn ngày!");

        $("#status-bar").text("Đang trích xuất dữ liệu toàn ngày...");
        const url = `https://api.thingspeak.com/channels/${node.id}/feeds.json?api_key=${node.key}&start=${pickedDate}%2000:00:00&end=${pickedDate}%2023:59:59`;

        $.getJSON(url, function(data) {
            if(!data.feeds || data.feeds.length === 0) {
                $("#status-bar").text("Không có dữ liệu trong ngày này.");
                return alert("Không có dữ liệu!");
            }

            let csv = "\uFEFFsep=,\nThời gian,Nhiệt độ(C),Độ ẩm(%),Ánh sáng(Lux),CO2(ppm)\n";
            data.feeds.forEach(f => {
                let time = new Date(f.created_at).toLocaleString('vi-VN').replace(/,/g, '');
                csv += `${time},${f.field1 || 0},${f.field2 || 0},${f.field3 || 0},${f.field4 || 0}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${node.name}_${pickedDate}.csv`;
            link.click();
            $("#status-bar").text("Xuất file thành công!");
        });
    }

    function selectNode(idx, btn) {
        if(idx === activeIdx) return;
        activeIdx = idx;
        $(".btn-node").removeClass("active"); $(btn).addClass("active");
        $("#nodeLabel").text(nodes[idx].name);
        
        // Reset màn hình chờ
        $(".stat-val").text("--");
        $("#tBody").html('<tr><td colspan="5" style="text-align:center">Đang chuyển Node...</td></tr>');
        
        // Xóa timer cũ và chạy ngay timer mới
        if(mainSyncTimer) clearInterval(mainSyncTimer);
        syncAll();
        mainSyncTimer = setInterval(syncAll, 5000);
    }

    function switchPage(p, btn) {
        $('.page').removeClass('active'); $("#" + p).addClass('active');
        $(".btn-page").removeClass("active"); $(btn).addClass("active");
    }

    $(document).ready(() => { 
        initCharts(); 
        syncAll(); 
        mainSyncTimer = setInterval(syncAll, 5000); 
    });
</script>
</body>
</html>
