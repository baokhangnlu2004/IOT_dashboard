<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Giám Sát Đa Node Pro</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0e14;
            --card: #161b22;
            --accent: #ff4d4d;
            --text-main: #f0f6fc;
            --text-sub: #8b949e;
            --blue: #58a6ff;
            --green: #238636;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        h1 { text-align: center; color: var(--blue); margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }

        /* Node Selector Buttons */
        .node-menu { display: flex; justify-content: center; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn-node {
            background: var(--card); color: var(--text-sub); border: 1px solid #30363d;
            padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        .btn-node.active { background: var(--blue); color: #fff; border-color: var(--blue); box-shadow: 0 0 20px rgba(88, 166, 255, 0.3); }

        /* Page Navigation */
        .nav-pages { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .btn-page {
            background: transparent; color: var(--text-main); border: 1px solid #30363d;
            padding: 10px 25px; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        .btn-page.active { background: #30363d; border-color: var(--accent); }
        .btn-excel { color: var(--green); border-color: var(--green); text-decoration: none; }
        .btn-excel:hover { background: var(--green); color: white; }

        /* Real-time Row (Top) */
        .realtime-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .rt-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #30363d;
            transition: transform 0.3s;
        }
        .rt-card:hover { transform: translateY(-5px); border-color: var(--blue); }
        .rt-card h4 { margin: 0; color: var(--text-sub); font-size: 13px; text-transform: uppercase; }
        .rt-val { font-size: 2.8rem; font-weight: 700; margin: 10px 0; color: var(--blue); }
        .rt-unit { color: var(--text-sub); font-size: 14px; }

        /* Charts Grid (Full width per chart) */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Luôn giữ 2 cột */
            gap: 25px;
        }
        .chart-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #30363d;
            min-height: 350px; /* Giữ biểu đồ cao và to */
        }

        /* Page Toggle */
        .page { display: none; max-width: 1200px; margin: auto; }
        .page.active { display: block; }

        /* History Table */
        .table-wrap { background: var(--card); border-radius: 16px; overflow: hidden; border: 1px solid #30363d; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1f242c; color: var(--blue); padding: 18px; text-align: left; font-size: 14px; }
        td { padding: 15px 18px; border-bottom: 1px solid #30363d; font-size: 14px; }
        tr:hover { background: #1c2128; }

        #status { text-align: center; margin-top: 30px; font-size: 13px; color: var(--green); }

        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; } /* Trên đt mới thu về 1 cột */
        }
    </style>
</head>
<body>

    <h1>IOT MONITORING SYSTEM</h1>

    <div class="node-menu">
        <button class="btn-node active" onclick="selectNode(0, this)">KHU VỰC 1</button>
        <button class="btn-node" onclick="selectNode(1, this)">KHU VỰC 2</button>
        <button class="btn-node" onclick="selectNode(2, this)">KHU VỰC 3</button>
        <button class="btn-node" onclick="selectNode(3, this)">KHU VỰC 4</button>
    </div>

    <div class="nav-pages">
        <button class="btn-page active" onclick="switchPage('dash', this)">DASHBOARD</button>
        <button class="btn-page" onclick="switchPage('table', this)">LỊCH SỬ DỮ LIỆU</button>
        <button class="btn-page btn-excel" onclick="exportToExcel()">XUẤT EXCEL 7 NGÀY</button>
    </div>

    <div id="dash" class="page active">
        <div class="realtime-row">
            <div class="rt-card"><h4>Nhiệt độ</h4><div id="vT" class="rt-val">--</div><span class="rt-unit">°C</span></div>
            <div class="rt-card"><h4>Độ ẩm</h4><div id="vH" class="rt-val">--</div><span class="rt-unit">%</span></div>
            <div class="rt-card"><h4>Ánh sáng</h4><div id="vL" class="rt-val">--</div><span class="rt-unit">Lux</span></div>
            <div class="rt-card"><h4>Khí CO2</h4><div id="vG" class="rt-val">--</div><span class="rt-unit">ppm</span></div>
        </div>

        <div class="charts-grid">
            <div class="chart-card"><canvas id="cT"></canvas></div>
            <div class="chart-card"><canvas id="cH"></canvas></div>
            <div class="chart-card"><canvas id="cL"></canvas></div>
            <div class="chart-card"><canvas id="cG"></canvas></div>
        </div>
    </div>

    <div id="table" class="page">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Thời gian</th><th>Nhiệt độ (°C)</th><th>Độ ẩm (%)</th><th>Ánh sáng (Lux)</th><th>CO2 (ppm)</th></tr>
                </thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div id="status">Đang tải dữ liệu từ Cloud...</div>

    <script>
        const config = [
            { id: "3206839", key: "YOVTV2A6N3NADZFU", name: "Khu vực 1" },
            { id: "3206869", key: "JBNAL9NDRB90ESWX", name: "Khu vực 2" },
            { id: "3206872", key: "JVSQYZ2HNBACNOWE", name: "Khu vực 3" },
            { id: "3206874", key: "YDKVK372O04PHALZ", name: "Khu vực 4" }
        ];

        let activeIdx = 0;
        let charts = {};

        function initCharts() {
            const setup = (id, label, color) => new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '15', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 0 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8b949e', font: { size: 12 } } } },
                    scales: {
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
            charts.t = setup('cT', 'Nhiệt độ (°C)', '#ff4d4d');
            charts.h = setup('cH', 'Độ ẩm (%)', '#58a6ff');
            charts.l = setup('cL', 'Ánh sáng (Lux)', '#ffcc00');
            charts.g = setup('cG', 'Khí CO2 (ppm)', '#238636');
        }

        function switchPage(p, btn) {
            $('.page').removeClass('active'); $("#" + p).addClass('active');
            $('.btn-page').removeClass('active'); $(btn).addClass('active');
        }

        function selectNode(idx, btn) {
            activeIdx = idx;
            $(".btn-node").removeClass("active"); $(btn).addClass("active");
            Object.values(charts).forEach(c => { c.data.labels = []; c.data.datasets[0].data = []; c.update(); });
            updateData();
        }

        function exportToExcel() {
            const node = config[activeIdx];
            const url = `https://api.thingspeak.com/channels/${node.id}/feeds.csv?api_key=${node.key}&days=7`;
            const link = document.createElement("a");
            link.href = url;
            link.download = `Data_7Days_Node_${node.name}.csv`;
            link.click();
        }

        function updateData() {
            const node = config[activeIdx];
            const url = `https://api.thingspeak.com/channels/${node.id}/feeds.json?api_key=${node.key}&results=20`;
            
            $.getJSON(url, function(res) {
                const feeds = res.feeds;
                if (feeds && feeds.length > 0) {
                    const last = feeds[feeds.length - 1];
                    const times = feeds.map(f => new Date(f.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

                    $("#vT").text(parseFloat(last.field1 || 0).toFixed(1));
                    $("#vH").text(parseFloat(last.field2 || 0).toFixed(1));
                    $("#vL").text(parseFloat(last.field3 || 0).toFixed(0));
                    $("#vG").text(last.field4 || "0");

                    const up = (c, fld) => { c.data.labels = times; c.data.datasets[0].data = feeds.map(f => f[fld]); c.update('none'); };
                    up(charts.t, 'field1'); up(charts.h, 'field2'); up(charts.l, 'field3'); up(charts.g, 'field4');

                    let h = "";
                    [...feeds].reverse().forEach(f => {
                        h += `<tr><td>${new Date(f.created_at).toLocaleString()}</td><td>${f.field1 || '--'}</td><td>${f.field2 || '--'}</td><td>${f.field3 || '--'}</td><td>${f.field4 || '--'}</td></tr>`;
                    });
                    $("#tBody").html(h);
                    $("#status").text("Khu vực hiện tại: " + node.name + " | Cập nhật: " + new Date().toLocaleTimeString());
                }
            });
        }

        $(document).ready(() => {
            initCharts();
            updateData();
            setInterval(updateData, 15000);
        });
    </script>
</body>
</html>
