<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Giám Sát - Layout Pro</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0e14;
            --card: #161b22;
            --accent: #ff4d4d;
            --text-main: #f0f6fc;
            --text-sub: #8b949e;
            --blue: #58a6ff;
            --green: #238636;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
        }

        h1 { text-align: center; color: var(--blue); margin: 10px 0; font-size: 22px; }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .btn {
            background: var(--card); color: var(--text-sub); border: 1px solid #30363d;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-node.active { background: var(--blue); color: #fff; border-color: var(--blue); }
        .btn-page.active { border-color: var(--accent); }
        .btn-excel { color: var(--green); border-color: var(--green); text-decoration: none; }

        /* LAYOUT CHÍNH: TRÁI BIỂU ĐỒ - PHẢI DỮ LIỆU */
        .main-container {
            display: flex;
            gap: 15px;
            max-width: 1600px;
            margin: auto;
        }

        /* Khối biểu đồ bên trái */
        .charts-side {
            flex: 3; /* Chiếm 75% */
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 cột */
            grid-template-rows: 350px 350px; /* 2 hàng */
            gap: 15px;
        }

        /* Khối số liệu bên phải */
        .data-side {
            flex: 1; /* Chiếm 25% */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-card {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #30363d;
            display: flex;
            flex-direction: column;
        }
        .chart-card canvas { flex-grow: 1; width: 100% !important; height: 100% !important; }

        .data-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #30363d;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .data-card h4 { margin: 0; font-size: 13px; color: var(--text-sub); text-transform: uppercase; }
        .data-val { font-size: 32px; font-weight: bold; color: var(--blue); margin: 5px 0; }
        .data-unit { font-size: 14px; color: var(--text-sub); }

        /* Page Toggle */
        .page { display: none; }
        .page.active { display: block; }

        /* Bảng dữ liệu */
        .table-wrap { max-width: 1200px; margin: auto; background: var(--card); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #30363d; }
        th { background: #1f242c; color: var(--blue); }

        #status { text-align: center; margin-top: 10px; font-size: 12px; color: var(--green); }

        /* Mobile */
        @media (max-width: 1000px) {
            .main-container { flex-direction: column-reverse; }
            .charts-side { grid-template-columns: 1fr; grid-template-rows: repeat(4, 300px); }
            .data-side { flex-direction: row; flex-wrap: wrap; }
            .data-card { flex: 1 1 150px; }
        }
    </style>
</head>
<body>

    <h1>SMART MONITORING DASHBOARD</h1>

    <div class="controls">
        <button class="btn btn-node active" onclick="selectNode(0, this)">KHU VỰC 1</button>
        <button class="btn btn-node" onclick="selectNode(1, this)">KHU VỰC 2</button>
        <button class="btn btn-node" onclick="selectNode(2, this)">KHU VỰC 3</button>
        <button class="btn btn-node" onclick="selectNode(3, this)">KHU VỰC 4</button>
    </div>

    <div class="controls">
        <button class="btn btn-page active" onclick="switchPage('dash', this)">DASHBOARD</button>
        <button class="btn btn-page" onclick="switchPage('table', this)">BẢNG DỮ LIỆU</button>
        <button class="btn btn-page btn-excel" onclick="exportToExcel()">XUẤT EXCEL 7 NGÀY</button>
    </div>

    <div id="dash" class="page active">
        <div class="main-container">
            <div class="charts-side">
                <div class="chart-card"><canvas id="cT"></canvas></div>
                <div class="chart-card"><canvas id="cH"></canvas></div>
                <div class="chart-card"><canvas id="cL"></canvas></div>
                <div class="chart-card"><canvas id="cG"></canvas></div>
            </div>

            <div class="data-side">
                <div class="data-card"><h4>Nhiệt độ</h4><div id="vT" class="data-val">--</div><span class="data-unit">°C</span></div>
                <div class="data-card"><h4>Độ ẩm</h4><div id="vH" class="data-val">--</div><span class="data-unit">%</span></div>
                <div class="data-card"><h4>Ánh sáng</h4><div id="vL" class="data-val">--</div><span class="data-unit">Lux</span></div>
                <div class="data-card"><h4>Khí CO2</h4><div id="vG" class="data-val">--</div><span class="data-unit">ppm</span></div>
                <div id="nodeLabel" style="text-align:center; font-size:12px; color:var(--blue)">Node: Khu vực 1</div>
            </div>
        </div>
    </div>

    <div id="table" class="page">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Thời gian</th><th>Temp (°C)</th><th>Humi (%)</th><th>Lux</th><th>CO2 (ppm)</th></tr>
                </thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div id="status">Đang kết nối...</div>

    <script>
        const config = [
            { id: "3206839", key: "YOVTV2A6N3NADZFU", name: "Khu vực 1" },
            { id: "3206869", key: "JBNAL9NDRB90ESWX", name: "Khu vực 2" },
            { id: "3206872", key: "JVSQYZ2HNBACNOWE", name: "Khu vực 3" },
            { id: "3206874", key: "YDKVK372O04PHALZ", name: "Khu vực 4" }
        ];

        let activeIdx = 0;
        let charts = {};

        function initCharts() {
            const setup = (id, label, color) => new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '15', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8b949e', font: { size: 11 } } } },
                    scales: {
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    }
                }
            });
            charts.t = setup('cT', 'Nhiệt độ (Trên)', '#ff4d4d');
            charts.h = setup('cH', 'Độ ẩm (Trên)', '#58a6ff');
            charts.l = setup('cL', 'Ánh sáng (Dưới)', '#ffcc00');
            charts.g = setup('cG', 'Khí CO2 (Dưới)', '#238636');
        }

        function switchPage(p, btn) {
            $('.page').removeClass('active'); $("#" + p).addClass('active');
            $('.btn-page').removeClass('active'); $(btn).addClass('active');
        }

        function selectNode(idx, btn) {
            activeIdx = idx;
            $(".btn-node").removeClass("active"); $(btn).addClass("active");
            $("#nodeLabel").text("Node: " + config[idx].name);
            Object.values(charts).forEach(c => { c.data.labels = []; c.data.datasets[0].data = []; c.update(); });
            updateData();
        }

        function exportToExcel() {
            const node = config[activeIdx];
            window.open(`https://api.thingspeak.com/channels/${node.id}/feeds.csv?api_key=${node.key}&days=7`);
        }

        function updateData() {
            const node = config[activeIdx];
            $.getJSON(`https://api.thingspeak.com/channels/${node.id}/feeds.json?api_key=${node.key}&results=20`, function(res) {
                const feeds = res.feeds;
                if (feeds && feeds.length > 0) {
                    const last = feeds[feeds.length - 1];
                    const times = feeds.map(f => new Date(f.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

                    $("#vT").text(parseFloat(last.field1 || 0).toFixed(1));
                    $("#vH").text(parseFloat(last.field2 || 0).toFixed(1));
                    $("#vL").text(parseFloat(last.field3 || 0).toFixed(0));
                    $("#vG").text(last.field4 || "0");

                    const up = (c, fld) => { c.data.labels = times; c.data.datasets[0].data = feeds.map(f => f[fld]); c.update('none'); };
                    up(charts.t, 'field1'); up(charts.h, 'field2'); up(charts.l, 'field3'); up(charts.g, 'field4');

                    let h = "";
                    [...feeds].reverse().forEach(f => {
                        h += `<tr><td>${new Date(f.created_at).toLocaleString()}</td><td>${f.field1}</td><td>${f.field2}</td><td>${f.field3}</td><td>${f.field4}</td></tr>`;
                    });
                    $("#tBody").html(h);
                    $("#status").text("Khu vực: " + node.name + " | " + new Date().toLocaleTimeString());
                }
            });
        }

        $(document).ready(() => {
            initCharts();
            updateData();
            setInterval(updateData, 15000);
        });
    </script>
</body>
</html>
